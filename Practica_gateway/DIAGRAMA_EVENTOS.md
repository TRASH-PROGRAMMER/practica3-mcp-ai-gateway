# ğŸ“Š Diagrama de Eventos de Negocio

## Arquitectura Event-Driven

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENTE / FRONTEND                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â”‚ POST /prescripciones              â”‚ GET /catalogo/precios?id=1
             â”‚                                   â”‚
             v                                   v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API GATEWAY (Puerto 3000)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ GatewayController        â”‚       â”‚ GatewayService           â”‚      â”‚
â”‚  â”‚ - POST /prescripciones   â”‚â”€â”€â”€â”€â”€â”€>â”‚ - registrarPrescripcion()â”‚      â”‚
â”‚  â”‚ - GET /catalogo/precios  â”‚â”€â”€â”€â”€â”€â”€>â”‚ - compararPrecios()      â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â”‚ RabbitMQ                         â”‚ RabbitMQ
             â”‚ Comando: registrar_prescripcion  â”‚ Query: comparar_precios
             â”‚                                   â”‚
             v                                   v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPARADOR SERVICE (Puerto 3002)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ PrescripcionController                                        â”‚     â”‚
â”‚  â”‚ @MessagePattern('registrar_prescripcion')                     â”‚     â”‚
â”‚  â”‚    â”‚                                                           â”‚     â”‚
â”‚  â”‚    â””â”€â”€> PrescripcionService.registrarPrescripcion()           â”‚     â”‚
â”‚  â”‚            â”‚                                                   â”‚     â”‚
â”‚  â”‚            â”œâ”€> 1. Guardar en BD (Prescripcion + Detalles)     â”‚     â”‚
â”‚  â”‚            â”‚                                                   â”‚     â”‚
â”‚  â”‚            â””â”€> 2. ğŸ”¥ EMIT: prescripcion.registrada            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ ComparadorController                                          â”‚     â”‚
â”‚  â”‚ @MessagePattern('comparar_precios')                           â”‚     â”‚
â”‚  â”‚    â”‚                                                           â”‚     â”‚
â”‚  â”‚    â””â”€â”€> ComparadorService.compararPrecios()                   â”‚     â”‚
â”‚  â”‚            â”‚                                                   â”‚     â”‚
â”‚  â”‚            â”œâ”€> 1. Calcular precios en farmacias               â”‚     â”‚
â”‚  â”‚            â”œâ”€> 2. Guardar en BD (Comparacion)                 â”‚     â”‚
â”‚  â”‚            â”‚                                                   â”‚     â”‚
â”‚  â”‚            â””â”€> 3. ğŸ”¥ EMIT: comparacion.realizada              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â”‚ RabbitMQ                         â”‚ RabbitMQ
             â”‚ Cola: producto_events            â”‚ Cola: producto_events
             â”‚                                   â”‚
             v                                   v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           RABBITMQ (Puerto 5672)                        â”‚
â”‚                                                                         â”‚
â”‚  Cola: producto_events (Eventos de Dominio)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ“‹ prescripcion.registrada                                    â”‚    â”‚
â”‚  â”‚  {                                                             â”‚    â”‚
â”‚  â”‚    event_type: "prescripcion.registrada",                      â”‚    â”‚
â”‚  â”‚    event_id: "prescripcion-123-1734234567890",                 â”‚    â”‚
â”‚  â”‚    data: { id_prescripcion, paciente, medicamentos, ... }      â”‚    â”‚
â”‚  â”‚  }                                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ” comparacion.realizada                                      â”‚    â”‚
â”‚  â”‚  {                                                             â”‚    â”‚
â”‚  â”‚    event_type: "comparacion.realizada",                        â”‚    â”‚
â”‚  â”‚    event_id: "comparacion-456-1734234567890",                  â”‚    â”‚
â”‚  â”‚    data: { id_comparacion, producto, ahorro_potencial, ... }   â”‚    â”‚
â”‚  â”‚  }                                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                   â”‚
             â”‚ @EventPattern                    â”‚ @EventPattern
             â”‚ Consumidores                     â”‚ Consumidores
             â”‚                                   â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
      â”‚             â”‚                    â”‚             â”‚
      v             v                    v             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Notifica- â”‚  â”‚Inventarioâ”‚        â”‚Analytics â”‚  â”‚Marketing â”‚
â”‚ciones    â”‚  â”‚Service   â”‚        â”‚Service   â”‚  â”‚Service   â”‚
â”‚Service   â”‚  â”‚          â”‚        â”‚          â”‚  â”‚          â”‚
â”‚          â”‚  â”‚          â”‚        â”‚          â”‚  â”‚          â”‚
â”‚- SMS     â”‚  â”‚- Reserva â”‚        â”‚- Top     â”‚  â”‚- Ofertas â”‚
â”‚- Email   â”‚  â”‚  stock   â”‚        â”‚  buscado â”‚  â”‚- Alertas â”‚
â”‚- Push    â”‚  â”‚- Alerta  â”‚        â”‚- Patronesâ”‚  â”‚  precios â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¥ Flujo Detallado: EVENTO 1 - `prescripcion.registrada`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. MÃ‰DICO REGISTRA PRESCRIPCIÃ“N                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ HTTP POST
             v
    POST /api/prescripciones
    {
      "id_paciente": 1,
      "nombre_paciente": "Juan PÃ©rez",
      "id_medico": 5,
      "nombre_medico": "Dra. MarÃ­a GonzÃ¡lez",
      "diagnostico": "HipertensiÃ³n",
      "medicamentos": [...]
    }
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GATEWAY â†’ RabbitMQ (COMANDO)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ RabbitMQ Message Pattern
             v
    comparadorClient.send({ cmd: 'registrar_prescripcion' }, dto)
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. COMPARADOR SERVICE - Procesamiento                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€> 3.1 Guardar Prescripcion (SQLite)
             â”‚   INSERT INTO prescripciones (...)
             â”‚
             â”œâ”€> 3.2 Guardar DetallePrescripcion (SQLite)
             â”‚   INSERT INTO detalle_prescripcion (...)
             â”‚
             â””â”€> 3.3 ğŸ”¥ EMITIR EVENTO
                 eventBus.emit('prescripcion.registrada', {
                   event_type: "prescripcion.registrada",
                   event_id: "prescripcion-123-...",
                   data: { ... }
                 })
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RABBITMQ - DistribuciÃ³n del Evento                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€> @EventPattern('prescripcion.registrada')
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de Notificaciones]
             â”‚    â”‚    â””â”€> EnvÃ­a SMS/Email al paciente
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de Inventario]
             â”‚    â”‚    â””â”€> Reserva medicamentos en farmacia
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de AuditorÃ­a]
             â”‚    â”‚    â””â”€> Registra para cumplimiento regulatorio
             â”‚    â”‚
             â”‚    â””â”€â”€> [Servicio de FacturaciÃ³n]
             â”‚         â””â”€> Prepara presupuesto
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RESPUESTA AL CLIENTE                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    {
      "prescripcion": { id_prescripcion: 123, ... },
      "detalles": [...],
      "evento_emitido": "prescripcion-123-1734234567890"
    }
```

---

## ğŸ” Flujo Detallado: EVENTO 2 - `comparacion.realizada`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USUARIO COMPARA PRECIOS                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ HTTP GET
             v
    GET /api/catalogo/precios?idProducto=1
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. GATEWAY â†’ RabbitMQ (QUERY)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ RabbitMQ Message Pattern
             v
    comparadorClient.send({ cmd: 'comparar_precios' }, { idProducto })
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. COMPARADOR SERVICE - Procesamiento                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€> 3.1 Obtener producto de Read Model
             â”‚   SELECT * FROM producto_read WHERE id_producto = 1
             â”‚
             â”œâ”€> 3.2 Consultar precios en farmacias (simulado)
             â”‚   [
             â”‚     { farmacia: "Central", precio: 95.50, ... },
             â”‚     { farmacia: "Del Ahorro", precio: 105.00, ... },
             â”‚     { farmacia: "San Pablo", precio: 100.00, ... }
             â”‚   ]
             â”‚
             â”œâ”€> 3.3 Calcular mÃ©tricas
             â”‚   - precio_min: 95.50
             â”‚   - precio_max: 105.00
             â”‚   - ahorro_potencial: 9.50
             â”‚
             â”œâ”€> 3.4 Guardar en BD
             â”‚   INSERT INTO comparaciones (...)
             â”‚
             â””â”€> 3.5 ğŸ”¥ EMITIR EVENTO
                 eventBus.emit('comparacion.realizada', {
                   event_type: "comparacion.realizada",
                   event_id: "comparacion-456-...",
                   data: { ... }
                 })
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. RABBITMQ - DistribuciÃ³n del Evento                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”œâ”€â”€> @EventPattern('comparacion.realizada')
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de Analytics]
             â”‚    â”‚    â””â”€> Actualiza: "Top 10 productos mÃ¡s buscados"
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de Recomendaciones]
             â”‚    â”‚    â””â”€> Sugiere alternativas genÃ©ricas mÃ¡s baratas
             â”‚    â”‚
             â”‚    â”œâ”€â”€> [Servicio de Marketing]
             â”‚    â”‚    â””â”€> Si ahorro > $20 â†’ EnvÃ­a alerta push
             â”‚    â”‚
             â”‚    â””â”€â”€> [Servicio de Reportes]
             â”‚         â””â”€> Dashboard: "Ahorro acumulado usuarios"
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. RESPUESTA AL CLIENTE                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    {
      "producto": "LosartÃ¡n 50mg",
      "comparaciones": [...],
      "ahorro_potencial": "$9.50",
      "mejor_precio": "Farmacia Central",
      "evento_emitido": "comparacion-456-1734234567890"
    }
```

---

## ğŸ“Š Tabla Comparativa de Eventos

| CaracterÃ­stica | `prescripcion.registrada` | `comparacion.realizada` |
|----------------|--------------------------|------------------------|
| **Tipo** | Comando (Write) | Query (Read) |
| **Frecuencia** | Baja (mÃ©dicos) | Alta (usuarios) |
| **Criticidad** | Alta âš ï¸ | Media |
| **Persistencia** | Obligatoria | Obligatoria |
| **Consumidores** | 4+ servicios | 3+ servicios |
| **Regulatorio** | SÃ­ (auditorÃ­a mÃ©dica) | No |
| **NotificaciÃ³n** | Inmediata (paciente) | Opcional |
| **Impacto BD** | Write + Read models | Read model + Analytics |

---

## ğŸ¯ Ventajas del Sistema de Eventos

### âœ… **1. Desacoplamiento**
```
SIN EVENTOS:
Prescripcion â†’ [Notificaciones + Inventario + FacturaciÃ³n]
            (Acoplamiento fuerte)

CON EVENTOS:
Prescripcion â†’ RabbitMQ â†’ [N Consumidores independientes]
            (Desacoplamiento total)
```

### âœ… **2. Escalabilidad**
- Cada consumidor escala independientemente
- RabbitMQ maneja backpressure automÃ¡ticamente

### âœ… **3. Auditabilidad**
- Cada evento tiene `event_id` Ãºnico
- Timestamp de emisiÃ³n
- Payload completo almacenado

### âœ… **4. Extensibilidad**
- Agregar nuevos consumidores sin modificar emisores
- Ejemplo: Agregar "Servicio de IA para detecciÃ³n de fraudes"

---

## ğŸ”’ GarantÃ­as de Entrega

### **RabbitMQ: At-least-once delivery**
```
1. Productor emite evento
2. RabbitMQ persiste en disco (durable: true)
3. Consumidor procesa
4. Consumidor envÃ­a ACK
5. RabbitMQ elimina mensaje

âŒ Si consumidor falla antes del ACK:
   â†’ RabbitMQ reenvÃ­a mensaje
   â†’ Posible procesamiento duplicado
   â†’ SOLUCIÃ“N: Implementar Idempotencia (Estrategia B)
```

---

## ğŸ“ PrÃ³ximos Pasos

1. âœ… **Implementado**: EmisiÃ³n de eventos de negocio
2. ğŸ”² **Pendiente**: Idempotent Consumer (Estrategia B)
3. ğŸ”² **Pendiente**: Dead Letter Queue (Estrategia A)
4. ğŸ”² **Pendiente**: Circuit Breaker (Estrategia D)
5. ğŸ”² **Pendiente**: Crear servicios consumidores reales
